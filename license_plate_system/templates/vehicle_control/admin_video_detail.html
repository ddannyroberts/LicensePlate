{% extends 'base.html' %}
{% load static %}
{% load vehicle_control_tags %}

{% block title %}Video Detection Details - Admin - LicenseGuard AI{% endblock %}

{% block extra_css %}
<style>
    .comparison-container {
        position: relative;
    }

    .plate-image-wrapper {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .plate-image-wrapper:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .plate-image {
        transition: all 0.3s ease;
        max-height: 120px;
        width: 100%;
        object-fit: cover;
    }

    .plate-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        padding: 0.4rem;
        text-align: center;
    }

    .plate-placeholder {
        background: rgba(255, 255, 255, 0.05);
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 1.5rem 1rem;
        text-align: center;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .plate-details {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 0.8rem;
        margin-bottom: 1rem;
    }

    .plate-details i {
        width: 20px;
    }

    .vs-icon {
        font-size: 1.5rem;
        color: #667eea;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 fw-bold">
                        <i class="fas fa-video me-2"></i>Video Detection Details
                    </h1>
                    <p class="text-muted mb-0">Video ID: {{ video.id }} | Status: 
                        <span class="badge bg-{% if video.status == 'completed' %}success{% elif video.status == 'processing' %}warning{% else %}danger{% endif %}">
                            {{ video.status|title }}
                        </span>
                    </p>
                </div>
                <a href="{% url 'vehicle_control:admin_video_list' %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>Back to List
                </a>
            </div>
        </div>
    </div>

    <!-- Video Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">Video Information</h5>
                        <p><strong>File:</strong> {{ video.video_file.name }}</p>
                        <p><strong>Uploaded by:</strong> {{ video.uploaded_by.username }}</p>
                        <p><strong>Uploaded at:</strong> {{ video.upload_timestamp|date:"M d, Y H:i" }}</p>
                        {% if video.processed_at %}
                        <p><strong>Processed at:</strong> {{ video.processed_at|date:"M d, Y H:i" }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3">Statistics</h5>
                        <p><strong>Known Plates Found:</strong> <span class="badge bg-success">{{ known_plates.count }}</span></p>
                        <p><strong>Unknown Plates Found:</strong> <span class="badge bg-warning text-dark">{{ unknown_plates.count }}</span></p>
                        <p><strong>Total Detections:</strong> <span class="badge bg-info">{{ known_plates.count|add:unknown_plates.count }}</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Known Plates -->
    {% if known_plates %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="glass-card p-4" data-aos="fade-up">
                <h3 class="mb-4">
                    <i class="fas fa-check-circle text-success me-2"></i>Known License Plates ({{ known_plates.count }})
                    <small class="text-white-50">- Found in Database</small>
                </h3>
                <div class="row">
                    {% for plate in known_plates %}
                    <div class="col-md-6 col-lg-4 mb-4" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|mul:100 }}">
                        <div class="glass-card p-3 h-100">
                            <div class="text-center mb-2">
                                <h6 class="text-white mb-2">
                                    <i class="fas fa-check-double text-success me-2"></i>Match Found
                                </h6>
                            </div>
                            
                            <!-- Comparison Images -->
                            <div class="comparison-container mb-2">
                                <div class="row g-2">
                                    <!-- Detected Plate Image -->
                                    <div class="col-6">
                                        <div class="text-center mb-1">
                                            <small class="text-white-50" style="font-size: 0.7rem;">Detected</small>
                                        </div>
                                        {% if plate.detection_image %}
                                        <div class="plate-image-wrapper">
                                            <img src="{{ plate.detection_image.url }}" 
                                                 alt="Detected: {{ plate.detected_plate_number }}"
                                                 class="img-fluid rounded plate-image"
                                                 style="border: 2px solid rgba(79, 172, 254, 0.5);">
                                            <div class="plate-overlay">
                                                <span class="badge bg-info" style="font-size: 0.7rem;">{{ plate.detected_plate_number }}</span>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="plate-placeholder">
                                            <i class="fas fa-image fa-2x text-muted mb-1"></i>
                                            <p class="text-muted small mb-0" style="font-size: 0.7rem;">{{ plate.detected_plate_number }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- VS Icon -->
                                    <div class="col-12 text-center my-1">
                                        <i class="fas fa-arrows-alt-h vs-icon"></i>
                                    </div>
                                    
                                    <!-- Registered Plate Image (from database) -->
                                    <div class="col-6">
                                        <div class="text-center mb-1">
                                            <small class="text-white-50" style="font-size: 0.7rem;">In Database</small>
                                        </div>
                                        {% if plate.registered_plate.plate_image %}
                                        <div class="plate-image-wrapper">
                                            <img src="{{ plate.registered_plate.plate_image.url }}" 
                                                 alt="Registered: {{ plate.registered_plate.plate_number }}"
                                                 class="img-fluid rounded plate-image"
                                                 style="border: 2px solid rgba(132, 250, 176, 0.5);">
                                            <div class="plate-overlay">
                                                <span class="badge bg-success" style="font-size: 0.7rem;">{{ plate.registered_plate.plate_number }}</span>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="plate-placeholder">
                                            <i class="fas fa-image fa-2x text-muted mb-1"></i>
                                            <p class="text-muted small mb-0" style="font-size: 0.7rem;">{{ plate.registered_plate.plate_number }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Details -->
                            <div class="plate-details">
                                <div class="mb-1">
                                    <i class="fas fa-user text-primary me-1" style="font-size: 0.8rem;"></i>
                                    <strong class="text-white" style="font-size: 0.85rem;">Owner:</strong>
                                    <span class="text-white-50" style="font-size: 0.8rem;">{{ plate.registered_plate.owner_name }}</span>
                                </div>
                                <div class="mb-1">
                                    <i class="fas fa-percentage text-info me-1" style="font-size: 0.8rem;"></i>
                                    <strong class="text-white" style="font-size: 0.85rem;">Confidence:</strong>
                                    <span class="text-white-50" style="font-size: 0.8rem;">{{ plate.confidence_score|floatformat:1 }}%</span>
                                </div>
                                <div class="mb-0">
                                    <i class="fas fa-clock text-warning me-1" style="font-size: 0.8rem;"></i>
                                    <strong class="text-white" style="font-size: 0.85rem;">Time:</strong>
                                    <span class="text-white-50" style="font-size: 0.8rem;">
                                        {% if plate.timestamp_seconds %}
                                        {{ plate.timestamp_seconds|floatformat:1 }}s
                                        {% else %}
                                        Frame {{ plate.frame_number }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="d-grid gap-1">
                                {% if plate.detection_image %}
                                <a href="{% url 'vehicle_control:view_plate_image' 'known' plate.id %}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-eye me-1"></i>View Detected
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Unknown Plates -->
    {% if unknown_plates %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="glass-card p-4" data-aos="fade-up" data-aos-delay="100">
                <h3 class="mb-4">
                    <i class="fas fa-question-circle text-warning me-2"></i>Unknown License Plates ({{ unknown_plates.count }})
                    <small class="text-white-50">- Not in Database</small>
                </h3>
                <div class="row">
                    {% for plate in unknown_plates %}
                    <div class="col-md-6 col-lg-4 mb-4" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|mul:100 }}">
                        <div class="glass-card p-3 h-100">
                            <div class="text-center mb-2">
                                <h6 class="text-white mb-2">
                                    <i class="fas fa-question-circle text-warning me-2"></i>Unknown Plate
                                </h6>
                            </div>
                            
                            <!-- Detected Plate Image -->
                            <div class="text-center mb-2">
                                <small class="text-white-50 d-block mb-1" style="font-size: 0.7rem;">Detected Plate</small>
                                {% if plate.detection_image %}
                                <div class="plate-image-wrapper">
                                    <img src="{{ plate.detection_image.url }}" 
                                         alt="Detected: {{ plate.detected_plate_number }}"
                                         class="img-fluid rounded plate-image"
                                         style="border: 2px solid rgba(240, 147, 251, 0.5);">
                                    <div class="plate-overlay">
                                        <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">{{ plate.detected_plate_number }}</span>
                                    </div>
                                </div>
                                {% else %}
                                <div class="plate-placeholder">
                                    <i class="fas fa-image fa-2x text-muted mb-1"></i>
                                    <p class="text-muted small mb-0" style="font-size: 0.7rem;">{{ plate.detected_plate_number }}</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Details -->
                            <div class="plate-details">
                                <div class="mb-1">
                                    <i class="fas fa-car text-warning me-1" style="font-size: 0.8rem;"></i>
                                    <strong class="text-white" style="font-size: 0.85rem;">Type:</strong>
                                    <span class="text-white-50" style="font-size: 0.8rem;">{{ plate.vehicle_type|default:"Unknown" }}</span>
                                </div>
                                <div class="mb-1">
                                    <i class="fas fa-percentage text-info me-1" style="font-size: 0.8rem;"></i>
                                    <strong class="text-white" style="font-size: 0.85rem;">Confidence:</strong>
                                    <span class="text-white-50" style="font-size: 0.8rem;">{{ plate.confidence_score|floatformat:1 }}%</span>
                                </div>
                                <div class="mb-0">
                                    <i class="fas fa-clock text-warning me-1" style="font-size: 0.8rem;"></i>
                                    <strong class="text-white" style="font-size: 0.85rem;">Time:</strong>
                                    <span class="text-white-50" style="font-size: 0.8rem;">
                                        {% if plate.timestamp_seconds %}
                                        {{ plate.timestamp_seconds|floatformat:1 }}s
                                        {% else %}
                                        Frame {{ plate.frame_number }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="d-grid gap-1">
                                {% if plate.detection_image %}
                                <a href="{% url 'vehicle_control:view_plate_image' 'unknown' plate.id %}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-eye me-1"></i>View Image
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Empty State -->
    {% if not known_plates and not unknown_plates %}
    <div class="row">
        <div class="col-12">
            <div class="glass-card p-5 text-center">
                <i class="fas fa-search fa-4x text-muted mb-4"></i>
                <h3 class="mb-3">No License Plates Detected</h3>
                <p class="text-muted">No license plates were found in this video.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

