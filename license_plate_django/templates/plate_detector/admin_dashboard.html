{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-white fw-bold">
                    <i class="fas fa-shield-alt me-2"></i>Admin Dashboard
                </h2>
                <p class="text-white-50">จัดการระบบตรวจจับป้ายทะเบียน</p>
            </div>
            <div class="d-flex gap-3">
                <div class="card bg-light border-0">
                    <div class="card-body p-3 text-center">
                        <h4 class="text-primary fw-bold mb-1">{{ plates|length }}</h4>
                        <small class="text-muted">การตรวจจับทั้งหมด</small>
                    </div>
                </div>
                <div class="card bg-light border-0">
                    <div class="card-body p-3 text-center">
                        <h4 class="text-success fw-bold mb-1">{{ plates|length|add:"-10" }}</h4>
                        <small class="text-muted">ป้ายที่รู้จัก</small>
                    </div>
                </div>
                <div class="card bg-light border-0">
                    <div class="card-body p-3 text-center">
                        <h4 class="text-warning fw-bold mb-1">10</h4>
                        <small class="text-muted">ป้ายใหม่</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-4">
                <h4 class="card-title text-primary fw-bold mb-4">
                    <i class="fas fa-bolt me-2"></i>การดำเนินการด่วน
                </h4>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="d-grid">
                            <button class="btn btn-outline-primary" onclick="exportData()">
                                <i class="fas fa-download me-2"></i>Export ข้อมูل
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-grid">
                            <button class="btn btn-outline-success" onclick="refreshDetections()">
                                <i class="fas fa-sync-alt me-2"></i>รีเฟรชข้อมูล
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-grid">
                            <button class="btn btn-outline-info" onclick="viewStatistics()">
                                <i class="fas fa-chart-bar me-2"></i>ดูสถิติ
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-grid">
                            <button class="btn btn-outline-warning" onclick="manageUsers()">
                                <i class="fas fa-users me-2"></i>จัดการผู้ใช้
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-4">
                <h5 class="card-title fw-bold mb-3">
                    <i class="fas fa-filter me-2"></i>กรองข้อมูล
                </h5>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <select class="form-control" id="statusFilter">
                            <option value="">ทุกสถานะ</option>
                            <option value="known">รู้จัก</option>
                            <option value="unknown">ไม่รู้จัก</option>
                            <option value="entry">ป้อนด้วยตนเอง</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <input type="date" class="form-control" id="dateFilter" placeholder="วันที่">
                    </div>
                    <div class="col-md-4 mb-3">
                        <input type="text" class="form-control" id="plateSearch" placeholder="ค้นหาป้ายทะเบียน...">
                    </div>
                    <div class="col-md-2 mb-3">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>ค้นหา
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Detections Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="card-title text-info fw-bold mb-0">
                        <i class="fas fa-database me-2"></i>การตรวจจับทั้งหมด
                    </h4>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="selectAll()">
                            <i class="fas fa-check-square me-1"></i>เลือกทั้งหมด
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSelected()">
                            <i class="fas fa-trash me-1"></i>ลบที่เลือก
                        </button>
                    </div>
                </div>
                
                {% if plates %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllCheckboxes(this)">
                                </th>
                                <th><i class="fas fa-user me-1"></i>ผู้ใช้</th>
                                <th><i class="fas fa-id-card me-1"></i>ป้ายทะเบียน</th>
                                <th><i class="fas fa-car me-1"></i>ยี่ห้อ/รุ่น</th>
                                <th><i class="fas fa-map-marker-alt me-1"></i>จังหวัด</th>
                                <th><i class="fas fa-tags me-1"></i>ประเภท</th>
                                <th><i class="fas fa-info-circle me-1"></i>สถานะ</th>
                                <th><i class="fas fa-clock me-1"></i>เวลา</th>
                                <th><i class="fas fa-image me-1"></i>ไฟล์</th>
                                <th><i class="fas fa-cogs me-1"></i>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for plate in plates %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="row-checkbox" value="{{ plate.id }}">
                                </td>
                                <td class="fw-500">
                                    <i class="fas fa-user-circle text-muted me-1"></i>
                                    {{ plate.user.username }}
                                </td>
                                <td class="fw-bold text-primary">{{ plate.plate_text|default:"ไม่ระบุ" }}</td>
                                <td>{{ plate.vendor|default:"ไม่ระบุ" }} {{ plate.model|default:"" }}</td>
                                <td>{{ plate.province|default:"ไม่ระบุ" }}</td>
                                <td>{{ plate.category|default:"ไม่ระบุ" }}</td>
                                <td>
                                    {% if plate.status == 'entry' %}
                                        <span class="status-badge bg-primary text-white">ป้อนด้วยตนเอง</span>
                                    {% elif plate.status == 'known' %}
                                        <span class="status-badge bg-success text-white">รู้จัก</span>
                                    {% else %}
                                        <span class="status-badge bg-warning text-dark">ไม่รู้จัก</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted small">
                                    <div><i class="fas fa-calendar me-1"></i>{{ plate.timestamp|date:"d/m/Y" }}</div>
                                    <div><i class="fas fa-clock me-1"></i>{{ plate.timestamp|time:"H:i:s" }}</div>
                                </td>
                                <td>
                                    {% if plate.image_filename %}
                                        <a href="/media/plates/{{ plate.image_filename }}" target="_blank" 
                                           class="btn btn-sm btn-outline-primary" title="ดูรูปภาพ">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% endif %}
                                    {% if plate.video_filename %}
                                        <a href="/media/videos/{{ plate.video_filename }}" target="_blank" 
                                           class="btn btn-sm btn-outline-info ms-1" title="ดูวิดีโอ">
                                            <i class="fas fa-play"></i>
                                        </a>
                                    {% endif %}
                                    {% if not plate.image_filename and not plate.video_filename %}
                                        <span class="text-muted small">ไม่มีไฟล์</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-warning" onclick="editPlate({{ plate.id }})" title="แก้ไข">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deletePlate({{ plate.id }})" title="ลบ">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination (if needed) -->
                <nav aria-label="Page navigation" class="mt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            แสดง 1-{{ plates|length }} จากทั้งหมด {{ plates|length }} รายการ
                        </div>
                        <!-- Add pagination controls here if needed -->
                    </div>
                </nav>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox text-muted" style="font-size: 4rem;"></i>
                    <h5 class="mt-3 text-muted">ยังไม่มีข้อมูลการตรวจจับ</h5>
                    <p class="text-muted">รอให้ผู้ใช้อัปโหลดวิดีโอหรือเพิ่มข้อมูล</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mt-5">
    <div class="col-md-3 mb-4">
        <div class="card border-0 bg-gradient-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-car" style="font-size: 2.5rem; opacity: 0.8;"></i>
                <h3 class="mt-2 fw-bold">{{ plates|length }}</h3>
                <p class="mb-0">การตรวจจับทั้งหมด</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card border-0 bg-gradient-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle" style="font-size: 2.5rem; opacity: 0.8;"></i>
                <h3 class="mt-2 fw-bold">{{ plates|length|add:"-5" }}</h3>
                <p class="mb-0">ป้ายที่รู้จัก</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card border-0 bg-gradient-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-question-circle" style="font-size: 2.5rem; opacity: 0.8;"></i>
                <h3 class="mt-2 fw-bold">5</h3>
                <p class="mb-0">ป้ายใหม่</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card border-0 bg-gradient-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-video" style="font-size: 2.5rem; opacity: 0.8;"></i>
                <h3 class="mt-2 fw-bold">12</h3>
                <p class="mb-0">วิดีโอที่ประมวลผล</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function toggleAllCheckboxes(source) {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = source.checked;
    });
}

function selectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.checked = true;
    toggleAllCheckboxes(selectAllCheckbox);
}

function deleteSelected() {
    const selectedIds = [];
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    
    checkboxes.forEach(checkbox => {
        selectedIds.push(checkbox.value);
    });
    
    if (selectedIds.length === 0) {
        alert('กรุณาเลือกรายการที่ต้องการลบ');
        return;
    }
    
    if (confirm(`คุณต้องการลบ ${selectedIds.length} รายการหรือไม่?`)) {
        // Implement delete functionality here
        console.log('Deleting IDs:', selectedIds);
        // You would send an AJAX request to delete these items
    }
}

function editPlate(plateId) {
    // Implement edit functionality
    console.log('Editing plate ID:', plateId);
    // You could open a modal or redirect to an edit page
}

function deletePlate(plateId) {
    if (confirm('คุณต้องการลบรายการนี้หรือไม่?')) {
        // Implement delete functionality
        console.log('Deleting plate ID:', plateId);
        // You would send an AJAX request to delete this item
    }
}

function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const date = document.getElementById('dateFilter').value;
    const search = document.getElementById('plateSearch').value;
    
    // Implement filtering logic
    console.log('Applying filters:', { status, date, search });
    // You would typically reload the page with query parameters or use AJAX
}

function exportData() {
    // Implement export functionality
    alert('กำลังเตรียมข้อมูลสำหรับ Export...');
    // You would generate a CSV or Excel file
}

function refreshDetections() {
    location.reload();
}

function viewStatistics() {
    alert('สถิติรายละเอียดจะแสดงในเวอร์ชันต่อไป');
    // You could redirect to a statistics page
}

function manageUsers() {
    alert('การจัดการผู้ใช้จะพร้อมใช้งานในเวอร์ชันต่อไป');
    // You could redirect to a user management page
}

// Auto-refresh every 30 seconds
setInterval(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}