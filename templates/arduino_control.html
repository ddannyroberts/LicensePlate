<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Gate Controller - License Plate System</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            border: none;
            border-radius: 15px;
            padding: 12px 25px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            border: none;
            border-radius: 15px;
            padding: 12px 25px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            padding: 12px 25px;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }

        .status-online {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .log-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>

            <h4 class="text-primary fw-bold mb-0">
                <i class="fas fa-microchip me-2"></i>Arduino Gate Controller
            </h4>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-4">
        <div class="row">
            <!-- Arduino Status -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-primary fw-bold">
                            <i class="fas fa-microchip me-2"></i>Arduino Status
                        </h5>

                        <div id="arduino-status">
                            <div class="d-flex align-items-center mb-3">
                                <span class="status-indicator status-offline" id="connection-indicator"></span>
                                <span id="connection-status">Checking connection...</span>
                            </div>

                            <!-- Arduino Mega 2560 Configuration -->
                            {% if config %}
                            <div class="alert alert-info" role="alert">
                                <h6 class="fw-bold mb-2"><i class="fas fa-microchip me-2"></i>Arduino Mega 2560 Configuration</h6>
                                <div class="small">
                                    <strong>Communication:</strong> {{ config.communication_method }}<br>
                                    {% if config.communication_method == 'SERIAL' %}
                                        <strong>Serial Port:</strong> {{ config.serial_port }}<br>
                                        <strong>Available Ports:</strong>
                                        {% if config.available_ports %}
                                            {{ config.available_ports|join(', ') }}
                                        {% else %}
                                            None detected
                                        {% endif %}<br>
                                        <strong>PySerial:</strong>
                                        {% if config.serial_available %}
                                            <span class="text-success">✓ Installed</span>
                                        {% else %}
                                            <span class="text-danger">✗ Not installed</span>
                                        {% endif %}
                                    {% elif config.communication_method == 'ETHERNET' %}
                                        <strong>IP Address:</strong> {{ config.ethernet_ip }}
                                    {% endif %}
                                </div>
                                <button class="btn btn-outline-info btn-sm mt-2" onclick="testConnection()">
                                    <i class="fas fa-plug me-1"></i>Test Connection
                                </button>
                            </div>
                            {% endif %}

                            <div class="info-box">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Gate Status:</strong><br>
                                        <span id="gate-status" class="badge bg-secondary">Unknown</span>
                                    </div>
                                    <div class="col-6">
                                        <strong>Communication:</strong><br>
                                        <span id="comm-method">{{ config.communication_method if config else 'Unknown' }}</span>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <strong>Uptime:</strong><br>
                                        <span id="arduino-uptime">-</span>
                                    </div>
                                    <div class="col-6">
                                        <strong>Auto-close in:</strong><br>
                                        <span id="auto-close-time">-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <button class="btn btn-success me-2" onclick="openGate()">
                                    <i class="fas fa-door-open me-2"></i>Open Gate
                                </button>
                                <button class="btn btn-danger me-2" onclick="closeGate()">
                                    <i class="fas fa-door-closed me-2"></i>Close Gate
                                </button>
                                <button class="btn btn-primary" onclick="refreshStatus()">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Control -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-warning fw-bold">
                            <i class="fas fa-hand-paper me-2"></i>Manual Override
                        </h5>

                        <p class="text-muted">Use this for emergency or manual gate control</p>

                        <div class="mb-3">
                            <label for="manual-plate" class="form-label">License Plate (Optional)</label>
                            <input type="text" class="form-control" id="manual-plate"
                                   placeholder="e.g., ABC123" style="border-radius: 15px;">
                        </div>

                        <div class="mb-3">
                            <label for="manual-owner" class="form-label">Owner Name (Optional)</label>
                            <input type="text" class="form-control" id="manual-owner"
                                   placeholder="e.g., John Doe" style="border-radius: 15px;">
                        </div>

                        <button class="btn btn-warning w-100" onclick="manualOverride()">
                            <i class="fas fa-exclamation-triangle me-2"></i>Manual Open Gate
                        </button>

                        <div class="alert alert-warning mt-3" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Manual operations will be logged in the access records.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Arduino Interface -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-info fw-bold">
                            <i class="fas fa-globe me-2"></i>Arduino Interface
                        </h5>

                        {% if config and config.communication_method == 'ETHERNET' %}
                            <p class="text-muted">Direct access to Arduino's built-in web interface via Ethernet</p>

                            <div class="d-flex align-items-center">
                                <input type="text" class="form-control me-3" id="arduino-url"
                                       readonly style="border-radius: 15px;">
                                <button class="btn btn-info" onclick="openArduinoInterface()">
                                    <i class="fas fa-external-link-alt me-2"></i>Open Interface
                                </button>
                            </div>
                        {% elif config and config.communication_method == 'SERIAL' %}
                            <p class="text-muted">Arduino Mega 2560 communicates via Serial - No web interface available</p>

                            <div class="alert alert-info" role="alert">
                                <h6 class="fw-bold mb-2"><i class="fas fa-terminal me-2"></i>Serial Communication</h6>
                                <div class="small">
                                    <strong>Port:</strong> {{ config.serial_port }}<br>
                                    <strong>Baud Rate:</strong> 115200<br>
                                    <strong>Commands:</strong> OPEN, CLOSE, STATUS, ACCESS:plate:auth
                                </div>
                            </div>

                            <div class="d-flex align-items-center">
                                <input type="text" class="form-control me-3" id="arduino-url"
                                       value="Serial Communication - Use commands via software"
                                       readonly style="border-radius: 15px;">
                                <button class="btn btn-secondary" disabled>
                                    <i class="fas fa-terminal me-2"></i>Serial Only
                                </button>
                            </div>
                        {% else %}
                            <p class="text-muted">Arduino interface configuration not available</p>

                            <div class="d-flex align-items-center">
                                <input type="text" class="form-control me-3" id="arduino-url"
                                       placeholder="Configuration loading..."
                                       readonly style="border-radius: 15px;">
                                <button class="btn btn-secondary" disabled>
                                    <i class="fas fa-question me-2"></i>Unknown
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-success fw-bold">
                            <i class="fas fa-list-alt me-2"></i>Activity Log
                        </h5>

                        <div class="log-box" id="activity-log">
                            <div class="text-muted">Activity log will appear here...</div>
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="clearLog()">
                                <i class="fas fa-trash me-2"></i>Clear Log
                            </button>
                            <span class="text-muted ms-3">
                                <i class="fas fa-clock me-1"></i>Auto-refresh every 5 seconds
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let statusInterval;
        let logEntries = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();

            // Auto-refresh status every 5 seconds
            statusInterval = setInterval(refreshStatus, 5000);

            addLogEntry('System initialized', 'info');
        });

        // Add log entry
        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                time: timestamp,
                message: message,
                type: type
            };

            logEntries.unshift(entry);
            if (logEntries.length > 50) {
                logEntries = logEntries.slice(0, 50);
            }

            updateLogDisplay();
        }

        // Update log display
        function updateLogDisplay() {
            const logBox = document.getElementById('activity-log');

            if (logEntries.length === 0) {
                logBox.innerHTML = '<div class="text-muted">No activity logged yet...</div>';
                return;
            }

            const html = logEntries.map(entry => {
                const colorClass = {
                    'info': 'text-primary',
                    'success': 'text-success',
                    'warning': 'text-warning',
                    'error': 'text-danger'
                }[entry.type] || 'text-muted';

                return `<div class="${colorClass}">[${entry.time}] ${entry.message}</div>`;
            }).join('');

            logBox.innerHTML = html;
        }

        // Refresh Arduino status
        async function refreshStatus() {
            try {
                const response = await fetch('/api/arduino/status');
                const data = await response.json();

                if (data.error) {
                    updateConnectionStatus(false, data.error);
                    addLogEntry(`Connection error: ${data.error}`, 'error');
                } else {
                    updateConnectionStatus(true);
                    updateStatusDisplay(data);
                    addLogEntry('Status updated successfully', 'info');
                }
            } catch (error) {
                updateConnectionStatus(false, 'Network error');
                addLogEntry(`Network error: ${error.message}`, 'error');
            }
        }

        // Update connection status
        function updateConnectionStatus(connected, error = null) {
            const indicator = document.getElementById('connection-indicator');
            const status = document.getElementById('connection-status');

            if (connected) {
                indicator.className = 'status-indicator status-online';
                status.textContent = 'Connected to Arduino';
                status.className = 'text-success fw-bold';
            } else {
                indicator.className = 'status-indicator status-offline';
                status.textContent = error || 'Disconnected from Arduino';
                status.className = 'text-danger fw-bold';
            }
        }

        // Update status display
        function updateStatusDisplay(data) {
            // Gate status
            const gateStatus = document.getElementById('gate-status');
            if (data.gate_open) {
                gateStatus.textContent = 'OPEN';
                gateStatus.className = 'badge bg-success';
            } else {
                gateStatus.textContent = 'CLOSED';
                gateStatus.className = 'badge bg-danger';
            }

            // Communication method and info
            const commMethod = document.getElementById('comm-method');
            if (data.communication) {
                commMethod.textContent = data.communication.toUpperCase();
            }

            // Update Arduino URL for Ethernet
            if (data.ip_address && data.communication === 'ethernet') {
                document.getElementById('arduino-url').value = `http://${data.ip_address}/`;
            } else if (data.communication === 'serial') {
                document.getElementById('arduino-url').value = 'Serial Communication - No Web Interface';
            }

            // Uptime
            if (data.uptime) {
                const seconds = data.uptime;
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                document.getElementById('arduino-uptime').textContent =
                    `${hours}h ${minutes % 60}m ${seconds % 60}s`;
            }

            // Auto-close time
            if (data.gate_open && data.time_remaining !== undefined) {
                document.getElementById('auto-close-time').textContent = `${data.time_remaining}s`;
            } else {
                document.getElementById('auto-close-time').textContent = '-';
            }
        }

        // Test Arduino connection
        async function testConnection() {
            try {
                addLogEntry('Testing Arduino connection...', 'info');

                const response = await fetch('/api/arduino/test_connection');
                const data = await response.json();

                if (data.status === 'connected') {
                    addLogEntry(`Connection test successful: ${data.message}`, 'success');
                    alert(`✅ Connection successful!\n${data.message}`);

                    // Update status with test data
                    if (data.data) {
                        updateStatusDisplay(data.data);
                    }
                } else {
                    let errorMsg = `Connection test failed: ${data.error}`;
                    if (data.available_ports) {
                        errorMsg += `\nAvailable ports: ${data.available_ports.join(', ')}`;
                    }
                    addLogEntry(errorMsg, 'error');
                    alert(`❌ Connection failed!\n${errorMsg}`);
                }
            } catch (error) {
                addLogEntry(`Connection test error: ${error.message}`, 'error');
                alert(`❌ Test failed!\nError: ${error.message}`);
            }
        }

        // Open gate
        async function openGate() {
            try {
                addLogEntry('Sending open gate command...', 'info');

                const response = await fetch('/api/arduino/open_gate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plate_number: 'MANUAL',
                        owner_name: 'Admin Manual Control'
                    })
                });

                const data = await response.json();

                if (data.error) {
                    addLogEntry(`Gate open failed: ${data.error}`, 'error');
                    alert(`Error: ${data.error}`);
                } else {
                    addLogEntry(`Gate opened successfully: ${data.message}`, 'success');
                    // Refresh status immediately
                    setTimeout(refreshStatus, 1000);
                }
            } catch (error) {
                addLogEntry(`Open gate error: ${error.message}`, 'error');
                alert(`Error: ${error.message}`);
            }
        }

        // Close gate
        async function closeGate() {
            try {
                addLogEntry('Sending close gate command...', 'info');

                const response = await fetch('/api/arduino/close_gate', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.error) {
                    addLogEntry(`Gate close failed: ${data.error}`, 'error');
                    alert(`Error: ${data.error}`);
                } else {
                    addLogEntry(`Gate closed successfully: ${data.message}`, 'success');
                    // Refresh status immediately
                    setTimeout(refreshStatus, 1000);
                }
            } catch (error) {
                addLogEntry(`Close gate error: ${error.message}`, 'error');
                alert(`Error: ${error.message}`);
            }
        }

        // Manual override
        async function manualOverride() {
            const plateNumber = document.getElementById('manual-plate').value || 'MANUAL_OVERRIDE';
            const ownerName = document.getElementById('manual-owner').value || 'Manual Override';

            if (!confirm(`Open gate for: ${plateNumber} (${ownerName})?`)) {
                return;
            }

            try {
                addLogEntry(`Manual override: ${plateNumber} - ${ownerName}`, 'warning');

                const response = await fetch('/api/arduino/open_gate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plate_number: plateNumber,
                        owner_name: ownerName
                    })
                });

                const data = await response.json();

                if (data.error) {
                    addLogEntry(`Manual override failed: ${data.error}`, 'error');
                    alert(`Error: ${data.error}`);
                } else {
                    addLogEntry(`Manual override successful: ${data.message}`, 'success');

                    // Clear inputs
                    document.getElementById('manual-plate').value = '';
                    document.getElementById('manual-owner').value = '';

                    // Refresh status
                    setTimeout(refreshStatus, 1000);
                }
            } catch (error) {
                addLogEntry(`Manual override error: ${error.message}`, 'error');
                alert(`Error: ${error.message}`);
            }
        }

        // Open Arduino interface
        function openArduinoInterface() {
            const url = document.getElementById('arduino-url').value;
            if (url && url !== '') {
                window.open(url, '_blank');
                addLogEntry('Opened Arduino web interface', 'info');
            } else {
                alert('Arduino IP address not available');
            }
        }

        // Clear log
        function clearLog() {
            logEntries = [];
            updateLogDisplay();
            addLogEntry('Log cleared by user', 'info');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        });
    </script>
</body>
</html>